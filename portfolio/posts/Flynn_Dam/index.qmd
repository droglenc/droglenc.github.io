---
title: Water Heights at Flynn Lake Dam
description: Analysis of water heights at the Pike Chain outlet on Flynn Lake.
author: Derek H. Ogle
date: 5/6/2023
image: Flynn_Dam.jpg
categories:
  - Pike Chain
  - Climate/Weather
  - Limnology
  - Vis
knitr:
  opts_chunk:
    fig.width: 6
    fig.height: 4
format: 
  html:
    df-print: kable
---

```{r}
#| label: setup
library(tidyverse)

## Helper to convert numeric inches to feet and inches label
convIn2Ft <- function(x,dec=0) {
  if (max(x)<12) paste0(round(x-floor(x/12)*12,dec),'"')
  else paste0(floor(x/12),"' ",round(x-floor(x/12)*12,dec),'"') 
}

## Helper to handle when max/min depth is on multiple days
lblMaxMinD <- function(x) {
  tmp <- length(x)
  if (tmp>1) {
    str_glue("earliest was {month(x[1],label=TRUE,abbr=FALSE)} {day(x[1])},
              latest was {month(x[tmp],label=TRUE,abbr=FALSE)} {day(x[tmp])}")
  } else {
    str_glue("on {month(x,label=TRUE,abbr=FALSE)} {day(x)}")
  }
}

## Set some constants
depvals <- 21:29  # inches
deplbls <- convIn2Ft(depvals)

rainlvls <- c("0 in","Tr-0.10 in","0.10-0.25 in","0.25-0.50 in","0.50-1.00 in",
              "1.00-3.00 in","3.00-5.00 in",">5.00 in")

## Create and set theme
theme_dam <- function() {
  theme_minimal(base_size=12) +
  theme(panel.grid.minor=element_line(linetype="dashed"),
        axis.title.x=element_blank(),
        axis.text.x=element_text(angle=270,hjust=0,vjust=0.25),
        plot.title=element_text(size=14,margin=margin(0,0,20,0)),
        plot.title.position="plot",
        legend.background=element_rect(fill="white",color="white"),
        legend.title=element_text(size=11)
        )
}
```

```{r}
#| label: data-prep
dat <- readxl::read_excel("../_data/Flynn_Dam_Heights.xlsx",skip=3) |>
  mutate(Date=as.Date(DateTime,format="%Y-%m-%d"),
         Rain2=case_when(
           Rain < 0.10 ~ "Tr-0.10 in",
           Rain < 0.25 ~ "0.10-0.25 in",
           Rain < 0.50 ~ "0.25-0.50 in",
           Rain < 1.00 ~ "0.50-1.00 in",
           Rain < 3.00 ~ "1.00-3.00 in",
           Rain < 5.00 ~ "3.00-5.00 in",
           Rain < 20.0 ~ ">5.00 in",
           TRUE ~ "0 in"),
         Rain2=factor(Rain2,levels=rainlvls))

dat2 <- dat |>
  mutate(dDepth=c(NA,diff(Depth))) |>
  slice(-1) |>
  select(-DateTime,-Notes)
```

```{r}
#| label: data-sum
tmp <- min(dat$DateTime)
dStart <- str_glue("{month(tmp,label=TRUE,abbr=FALSE)} {day(tmp)}")
tmp <- max(dat$DateTime)  
dEnd <- str_glue("{month(tmp,label=TRUE,abbr=FALSE)} {day(tmp)}")

maxD <- max(dat$Depth)
lblMaxD <- convIn2Ft(maxD*12,dec=1)
dMaxD <- lblMaxMinD(dat$DateTime[dat$Depth==maxD])

minD <- min(dat$Depth)
lblMinD <- convIn2Ft(minD*12,dec=1)
dMinD <- lblMaxMinD(dat$DateTime[dat$Depth==minD])

rngD <- maxD-minD
lblRngD <- convIn2Ft(rngD*12,dec=1)

maxDD <- max(dat2$dDepth)
lblMaxDD <- convIn2Ft(maxDD*12,dec=1)
rainMaxDD <- dat2$Rain[dat2$dDepth==maxDD]
dMaxDD <- lblMaxMinD(dat$DateTime[dat2$dDepth==maxDD])
```


```{r}
#| label: FlynnDam
#| out-width: 67%
knitr::include_graphics("Flynn_Dam.jpg")
```

:::{.callout-warning icon=false}
# Summary
- Stream gauge measurements (i.e., water levels) were made daily at the Flynn Lake dam (outlet of Pike Chain of Lakes) from `r dStart` to `r dEnd` 2023. Water flowed continuously over the dam during this period.
- Water levels fluctuated `r lblRngD`, from a low of `r lblMinD` (`r dMinD`) to a high of `r lblMaxD` (`r dMaxD`).
- The greatest daily change in water level was an increase of `r lblMaxDD` `r dMaxDD` following `r rainMaxDD`" of rain. Interestingly lower daily water level increases were observed following greater amounts of rain on other dates.
- In the absence of rain, water levels generally dropped between 1/8" and 1/4" per day (for the water levels observed in this year).
:::

&nbsp;

```{r}
#| label: depth_series_wrain
#| fig-width: 8
#| fig-height: 6
tmp_title <- stringr::str_wrap("Water depth at Flynn Lake dam by date with points color coded by the amount of rain since the previous observation.",width=80)
tmp_source <- "Source: Derek Ogle, personal observation"

ggplot(data=dat,mapping=aes(x=DateTime,y=Depth)) +
  geom_line(color="slategray",linewidth=2.5) +
  geom_point(mapping=aes(fill=Rain2),shape=21,color="slategray",size=2.5) +
  scale_x_datetime(date_breaks="1 week",date_minor_breaks="1 day",
                   date_labels="%b %e",expand=expansion(mult=0.025)) +
  scale_y_continuous(name="Gauge Depth",expand=expansion(mult=0),
                     limits=range(depvals/12),breaks=depvals/12,labels=deplbls,
                     minor_breaks=(rep(depvals,each=10)+seq(0,0.9,0.1))/12) +
  scale_fill_brewer(name="Rain Amount",palette="YlOrRd") +
  labs(title=tmp_title,caption=tmp_source) +
  theme_dam() +
  theme(legend.position=c(1,1),
        legend.justification=c(1.1,1.1))
```


&nbsp;

```{r}
#| label: delta_depth_series_wrain
#| fig-width: 8
#| fig-height: 6

tmp_title <- stringr::str_wrap("Change from the previous day for water depth at Flynn Lake dam by date with points color coded by the amount of rain since the previous observation.",width=80)

dDepvals <- seq(2.5,-0.75,by=-0.25)
dDeplbls <- paste0(formatC(dDepvals,format="f",digits=2),'"')

ggplot(data=dat2,mapping=aes(x=Date)) +
  geom_hline(yintercept=0,linetype="dashed",linewidth=1) +
  geom_segment(mapping=aes(y=0,yend=dDepth,xend=Date),
               linewidth=1.25,color="slategray") +
  geom_point(mapping=aes(y=dDepth,fill=Rain2),
             shape=21,color="slategray",size=2.5) +
  scale_x_date(date_breaks="1 week",date_minor_breaks="1 day",
                   date_labels="%b %e",expand=expansion(mult=0.025)) +
  scale_y_continuous(name="Change from Previous Day",expand=expansion(mult=0.02),
                     limits=range(dDepvals/12),breaks=dDepvals/12,labels=dDeplbls) +
  scale_fill_brewer(name="Rain Amount",palette="YlOrRd") +
  annotate(geom="text",x=max(dat2$Date)+3,y=0.5/12,label="Rising",
           angle=270,size=4) +
  annotate(geom="text",x=max(dat2$Date)+3,y=-0.25/12,label="Falling",
           angle=270,size=4) +
  labs(title=tmp_title,caption=tmp_source) +
  theme_dam() +
  theme(legend.position=c(0,1),
        legend.justification=c(-0.05,1.05))
```

&nbsp;

:::{.callout-important icon=false}
## Acknowledgments

Thanks to Hal A, Ieuan A, Joe R., Kevin S., and Tim T. for taking the measurements when I could not!!
:::
